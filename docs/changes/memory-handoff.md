# Change Document: memory-handoff

**Status**: approved
**Branch**: feature/memory-handoff
**Created**: 2026-02-06
**Author**: Change Agent

---

## Summary

Korrektur der Workflow-Reihenfolge: Nach Verify kommt Memory (nicht Release), und Memory verzweigt dann zu Change (nächster Change) oder Release. Specs (US/REQ) beschrieben die Reihenfolge bereits korrekt, aber der Exit-Punkt nach Memory fehlte. Agent-Handoffs waren falsch verdrahtet (verify → release → memory statt verify → memory → change/release).

---

## Level 0: User Stories

**Status**: ✅ completed

### Modified User Stories
- US_WF_CHANGE: End-to-End Change Workflow — +Acceptance Scenario 6 (nach Memory: Change oder Release)

---

## Level 1: Requirements

**Status**: ✅ completed

### Modified Requirements
- REQ_WF_CHANGE_SEQUENCE: Change Workflow Sequence — +AC-6, Rationale erweitert, Description erweitert

---

## Level 2: Design

**Status**: ✅ completed

### Modified Design Elements
- SPEC_AGENT_WORKFLOW: Four-Agent Workflow — Workflow-Diagramm (Verzweigung nach Memory), Main Chain (Memory in Chain), Memory-Beschreibung (Handoffs)
- SPEC_MEM_UPDATE_PROCESS: Memory Update Process — Invocation-Absatz (Handoffs statt standalone)

### Agent-Datei-Änderungen
- syspilot.verify.agent.md: Handoff "Create Release" → "Update Memory" (verify → memory statt verify → release)
- syspilot.memory.agent.md: +Handoffs zu change und release

---

## Final Consistency Check

**Status**: ✅ passed

### Traceability

| User Story | Requirements | Design | Complete? |
|------------|-------------|--------|-----------|
| US_WF_CHANGE (+AS-6) | REQ_WF_CHANGE_SEQUENCE (+AC-6) | SPEC_AGENT_WORKFLOW, SPEC_MEM_UPDATE_PROCESS | ✅ |

---

*Generated by syspilot Change Agent*

---

## Level 0: User Stories

**Status**: ✅ completed

### Impacted User Stories

| ID | Title | Impact | Notes |
|----|-------|--------|-------|
| US_WF_CHANGE | End-to-End Change Workflow | modified | Neues Acceptance Scenario 6: nach Memory entweder neuer Change oder Release |

### New User Stories

_Keine neuen User Stories nötig._

### Modified User Stories

#### US_WF_CHANGE: End-to-End Change Workflow

```rst
.. story:: End-to-End Change Workflow
   :id: US_WF_CHANGE
   :status: draft
   :priority: mandatory
   :tags: core, workflow, agents
   :links: US_CORE_SPEC_AS_CODE, US_CHG_ANALYZE, US_CHG_IMPLEMENT, US_CHG_VERIFY, US_DX_PROJECT_MEMORY

   **As a** developer,
   **I want to** follow a defined workflow (Change → Implement → Verify → Memory)
   to evolve my specifications and code,
   **so that** every change is analyzed, implemented with traceability, verified,
   and captured in project memory.

   **Acceptance Scenarios:**

   1. Given I have a change request, When I start the workflow, Then I know to
      invoke @change first
   2. Given @change produces an approved Change Document, When I proceed, Then
      I invoke @implement with the Change Document as input
   3. Given @implement completes, When I proceed, Then I invoke @verify to check
      completeness
   4. Given @verify passes, When I proceed, Then I invoke @memory to update
      project context
   5. Given any step fails, When I check the workflow, Then I know which step
      to revisit
   6. Given @memory completes, When I decide next steps, Then I can either
      start a new change workflow (@change) or proceed to release (@release)
```

### Decisions

- Decision 1: Acceptance Scenario 6 hinzufügen statt neue US — der Verzweigungspunkt gehört zur selben Story

### Horizontal Check (MECE)

- [x] No contradictions with existing User Stories (US_WF_QUALITY, US_WF_RELEASE)
- [x] No redundancies
- [x] Gaps identified and addressed (Exit nach Memory war undefiniert)

---

## Level 1: Requirements

**Status**: ✅ completed

### Impacted Requirements

| ID | Linked From | Impact | Notes |
|----|-------------|--------|-------|
| REQ_WF_CHANGE_SEQUENCE | US_WF_CHANGE | modified | Neues AC-6: Exit-Punkt nach Memory (Change oder Release) |

### Modified Requirements

#### REQ_WF_CHANGE_SEQUENCE: Change Workflow Sequence

```rst
.. req:: Change Workflow Sequence
   :id: REQ_WF_CHANGE_SEQUENCE
   :status: draft
   :priority: mandatory
   :tags: workflow, change, orchestration
   :links: US_WF_CHANGE

   **Description:**
   syspilot SHALL define a change workflow with the following sequence:

   1. **@change** — Analyze change request, create Change Document (US → REQ → SPEC)
   2. **@implement** — Execute approved changes from Change Document
   3. **@verify** — Validate implementation against Change Document
   4. **@memory** — Update project memory (copilot-instructions.md)

   After @memory completes, the user SHALL be offered to either start a new
   change workflow or proceed to a release.

   **Rationale:**
   A defined sequence ensures consistent change processing. Each step
   produces output that the next step consumes, creating a pipeline
   with clear handoff points. The exit point after @memory supports
   iterative development (multiple changes) before bundling into a release.

   **Acceptance Criteria:**

   * AC-1: Workflow sequence is documented and accessible to users and agents
   * AC-2: Each step's output serves as input to the next step
   * AC-3: Change Document is the shared artifact between @change and @implement
   * AC-4: @verify references the Change Document for completeness checks
   * AC-5: @memory runs after successful verification
   * AC-6: After @memory, the workflow offers two exit paths: start a new
     change workflow (@change) or proceed to release (@release)
```

### Decisions

- Decision 1: AC-6 hinzufügen für den Verzweigungspunkt nach Memory

### Horizontal Check (MECE)

- [x] No contradictions with existing Requirements (REQ_WF_QUALITY_INDEPENDENT, REQ_WF_RELEASE_SEQUENCE)
- [x] No redundancies
- [x] All REQs link to User Stories

---

## Level 2: Design

**Status**: ✅ completed

### Impacted Design Elements

| ID | Linked From | Impact | Notes |
|----|-------------|--------|-------|
| SPEC_AGENT_WORKFLOW | REQ_WF_CHANGE_SEQUENCE | modified | Workflow-Diagramm, Main Chain, Memory-Beschreibung |
| SPEC_MEM_UPDATE_PROCESS | REQ_DX_MEMORY_AGENT | modified | Invocation: Handoffs zu change und release |

### Modified Design Elements

#### SPEC_AGENT_WORKFLOW: Four-Agent Workflow

Änderungen:
- Workflow-Diagramm: Verzweigungspunkt nach Memory (→ change oder → release)
- Main Chain: Memory ist Teil der Chain, nicht standalone
- Memory Agent Beschreibung: "Standalone without handoffs" → Handoffs zu change und release

```rst
.. spec:: Four-Agent Workflow
   :id: SPEC_AGENT_WORKFLOW
   :status: draft
   :links: REQ_WF_CHANGE_SEQUENCE, REQ_CHG_ANALYSIS_AGENT, REQ_CHG_IMPL_AGENT, REQ_CHG_VERIFY_AGENT, REQ_DX_MEMORY_AGENT, REQ_CHG_WORKFLOW_STEPS
   :tags: architecture, agents

   **Design:**
   syspilot implements a four-agent workflow for structured change management.

   **Agent Responsibilities:**

   1. **change agent**: Analyze request + current implementation → Change Document + US/REQ/SPEC updates
   2. **implement agent**: Read Change Document → Code + Scripts + Tests (no spec changes)
   3. **verify agent**: Implementation → Verification Report
   4. **memory agent**: Project → Updated copilot-instructions.md

   **Workflow:**

   ::

      User Request
           │
           ▼
      ┌─────────────┐
      │   change    │ ──→ Change Document + US/REQ/SPEC RST updates
      └─────────────┘
           │
           ▼ (approved)
      ┌─────────────┐
      │  implement  │ ──→ Code + Scripts + Tests (reads SPECs from Change Doc)
      └─────────────┘
           │
           ▼
      ┌─────────────┐
      │   verify    │ ──→ Verification Report
      └─────────────┘
           │
           ▼ (passed)
      ┌─────────────┐
      │   memory    │ ──→ Updated copilot-instructions.md
      └─────────────┘
           │
           ▼
      ┌──────────┬──────────┐
      │  change  │ release  │  (user decides)
      └──────────┴──────────┘

   **Files:**

   * ``.github/agents/syspilot.change.agent.md``
   * ``.github/agents/syspilot.implement.agent.md``
   * ``.github/agents/syspilot.verify.agent.md``
   * ``.github/agents/syspilot.memory.agent.md``

   **VS Code Handoffs:**

   Each agent file includes YAML frontmatter with ``handoffs:`` that enable
   VS Code to suggest the next agent in the workflow.

   **Main Chain:**

   ::

      change → implement → verify → memory
          ↑                            │
          ├────────────────────────────┘ (next change)
          │
          └── or ──→ release (bundle changes)

   **Analysis Agents (bidirectional):**

   ::

      mece ↔ trace
        │       │
        └───────┴──→ change (to fix issues)

   **Memory Agent:**

   Invoked after verify. Hands off to change (for next change) or
   release (to bundle changes into a versioned release).

   **Handoff Format:**

   ::

      ---
      description: Short agent purpose for UI display
      handoffs:
        - label: Display name
          agent: syspilot.targetagent
          prompt: Default prompt text
      ---

   **Initial Prompt Recommendations:**

   To show syspilot agents as suggestions when opening a new chat,
   configure VS Code workspace settings:

   **File:** ``.vscode/settings.json``

   ::

      {
        "chat.promptFilesRecommendations": {
          "syspilot.change": true,
          "syspilot.implement": true,
          "syspilot.verify": true,
          "syspilot.mece": true,
          "syspilot.trace": true,
          "syspilot.memory": true
        }
      }

   This ensures users see syspilot workflow options immediately.
```

#### SPEC_MEM_UPDATE_PROCESS: Memory Update Process

Änderung: Invocation Absatz

```
**Invocation:** Invoked after verify in the change workflow.
Hands off to change (for another change) or release (to bundle into a release).

**File:** ``.github/agents/syspilot.memory.agent.md``
```

### Agent-Datei-Änderungen

#### syspilot.verify.agent.md — Handoff "Create Release" → "Update Memory"

```yaml
handoffs:
  - label: Fix Issues
    agent: syspilot.implement
    prompt: Fix the issues found
  - label: New Change Request
    agent: syspilot.change
    prompt: Create Change Proposal to fix issues
  - label: Update Memory
    agent: syspilot.memory
    prompt: Update project memory after verification
```

#### syspilot.memory.agent.md — Handoffs hinzufügen

```yaml
handoffs:
  - label: New Change
    agent: syspilot.change
    prompt: Start a new change workflow
  - label: Create Release
    agent: syspilot.release
    prompt: Prepare release from completed changes
```

### Decisions

- Decision 1: Verify → Release Handoff entfernen, durch Verify → Memory ersetzen
- Decision 2: Memory bekommt Handoffs zu Change und Release

### Horizontal Check (MECE)

- [x] No contradictions with existing Designs
- [x] All SPECs link to Requirements

---

## Final Consistency Check

**Status**: ⏳ not started

---

*Generated by syspilot Change Agent*
